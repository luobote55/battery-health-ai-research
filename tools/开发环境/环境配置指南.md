# 开发环境配置指南

## 系统要求

### 硬件要求

**最低配置**:
- CPU: 4核及以上
- 内存: 8GB RAM
- 硬盘: 50GB可用空间

**推荐配置**:
- CPU: 8核及以上
- 内存: 16GB+ RAM
- GPU: NVIDIA GPU (CUDA支持,用于深度学习训练)
- 硬盘: 100GB+ SSD

### 操作系统
- Ubuntu 20.04+ / macOS 12+ / Windows 10+
- Python 3.8 - 3.11

---

## 方案1: 微调模型开发环境

### 1. Anaconda环境安装

```bash
# 下载Anaconda (Linux)
wget https://repo.anaconda.com/archive/Anaconda3-2024.02-1-Linux-x86_64.sh
bash Anaconda3-2024.02-1-Linux-x86_64.sh

# macOS
wget https://repo.anaconda.com/archive/Anaconda3-2024.02-1-MacOSX-x86_64.sh
bash Anaconda3-2024.02-1-MacOSX-x86_64.sh

# Windows: 下载.exe安装包
# https://www.anaconda.com/download
```

### 2. 创建虚拟环境

```bash
# 创建环境
conda create -n battery-ml python=3.10 -y
conda activate battery-ml

# 验证
python --version  # Python 3.10.x
```

### 3. 安装PyTorch (GPU版本)

```bash
# CUDA 11.8 (NVIDIA GPU)
conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia

# CUDA 12.1
conda install pytorch torchvision torchaudio pytorch-cuda=12.1 -c pytorch -c nvidia

# CPU版本 (无GPU)
conda install pytorch torchvision torchaudio cpuonly -c pytorch

# 验证安装
python -c "import torch; print(torch.__version__); print(torch.cuda.is_available())"
```

### 4. 安装核心库

```bash
# 数据处理
pip install numpy pandas scipy matplotlib seaborn

# 机器学习
pip install scikit-learn xgboost lightgbm

# 深度学习辅助
pip install tensorboard torchsummary

# 实验管理
pip install mlflow wandb

# 数据版本管理
pip install dvc

# Jupyter
pip install jupyter ipykernel
python -m ipykernel install --user --name battery-ml --display-name "Battery ML"
```

### 5. 电池专用库

```bash
# 电池物理模型
pip install pybamm

# 微软电池ML工具
pip install batteryml

# 时序数据处理
pip install tslearn statsmodels
```

### 6. requirements.txt

创建 `tools/开发环境/requirements-ml.txt`:

```txt
# 核心框架
torch==2.1.0
torchvision==0.16.0
numpy==1.24.3
pandas==2.0.3
scipy==1.11.1

# 机器学习
scikit-learn==1.3.0
xgboost==2.0.0
lightgbm==4.0.0

# 可视化
matplotlib==3.7.2
seaborn==0.12.2
plotly==5.16.1

# 实验管理
mlflow==2.6.0
wandb==0.15.8

# Jupyter
jupyter==1.0.0
ipykernel==6.25.1

# 电池专用
pybamm==23.5
batteryml==0.1.0

# 时序处理
tslearn==0.6.2
statsmodels==0.14.0

# 工具
tqdm==4.66.1
```

安装:
```bash
pip install -r tools/开发环境/requirements-ml.txt
```

---

## 方案2: RAG开发环境

### 1. 创建虚拟环境

```bash
conda create -n battery-rag python=3.10 -y
conda activate battery-rag
```

### 2. 安装LangChain生态

```bash
# LangChain核心
pip install langchain langchain-community langchain-core

# LlamaIndex (可选)
pip install llama-index

# 向量数据库
pip install chromadb  # 轻量级,适合原型
# pip install pinecone-client  # 生产级
# pip install weaviate-client  # 生产级
# pip install qdrant-client  # 开源生产级

# Embedding模型
pip install sentence-transformers
pip install openai  # OpenAI Embeddings

# LLM接口
pip install openai  # GPT系列
pip install anthropic  # Claude
# pip install dashscope  # 阿里云通义千问
# pip install zhipuai  # 智谱AI
```

### 3. 文档处理

```bash
# 文档解析
pip install unstructured
pip install pypdf pymupdf  # PDF
pip install python-docx  # Word
pip install openpyxl  # Excel
pip install python-pptx  # PowerPoint

# OCR支持
pip install pytesseract pillow

# 表格提取
pip install tabula-py camelot-py
```

### 4. Web框架

```bash
# 快速原型
pip install streamlit gradio

# 生产API
pip install fastapi uvicorn pydantic

# 工具
pip install requests beautifulsoup4
```

### 5. requirements-rag.txt

```txt
# LangChain生态
langchain==0.1.0
langchain-community==0.0.10
langchain-core==0.1.10
llama-index==0.9.30

# 向量数据库
chromadb==0.4.20
sentence-transformers==2.2.2

# LLM接口
openai==1.6.1
anthropic==0.8.1

# 文档处理
unstructured==0.11.5
pypdf==3.17.1
pymupdf==1.23.8
python-docx==1.1.0
openpyxl==3.1.2
python-pptx==0.6.23

# Web框架
streamlit==1.29.0
gradio==4.13.0
fastapi==0.108.0
uvicorn==0.25.0

# 工具
requests==2.31.0
beautifulsoup4==4.12.2
tqdm==4.66.1
```

---

## 方案3: 混合环境 (推荐)

### 1. 创建统一环境

```bash
conda create -n battery-ai python=3.10 -y
conda activate battery-ai
```

### 2. 安装所有依赖

```bash
# PyTorch (根据GPU情况选择)
conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia

# 安装所有库
pip install -r tools/开发环境/requirements-full.txt
```

### 3. requirements-full.txt

```txt
# ==== 深度学习 ====
torch==2.1.0
torchvision==0.16.0
numpy==1.24.3
pandas==2.0.3
scipy==1.11.1
scikit-learn==1.3.0
xgboost==2.0.0
lightgbm==4.0.0

# ==== RAG ====
langchain==0.1.0
langchain-community==0.0.10
chromadb==0.4.20
sentence-transformers==2.2.2
openai==1.6.1
anthropic==0.8.1

# ==== 文档处理 ====
unstructured==0.11.5
pypdf==3.17.1
python-docx==1.1.0
openpyxl==3.1.2

# ==== Web框架 ====
streamlit==1.29.0
fastapi==0.108.0
uvicorn==0.25.0

# ==== 可视化 ====
matplotlib==3.7.2
seaborn==0.12.2
plotly==5.16.1

# ==== 实验管理 ====
mlflow==2.6.0
jupyter==1.0.0

# ==== 电池专用 ====
pybamm==23.5

# ==== 工具 ====
tqdm==4.66.1
requests==2.31.0
```

---

## GPU配置 (NVIDIA)

### 1. 检查GPU

```bash
# 检查NVIDIA驱动
nvidia-smi

# 应显示GPU信息:
# GPU Name, Driver Version, CUDA Version
```

### 2. 安装CUDA Toolkit (可选)

```bash
# Ubuntu 20.04
wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run
sudo sh cuda_11.8.0_520.61.05_linux.run

# 添加到环境变量
echo 'export PATH=/usr/local/cuda-11.8/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc

# 验证
nvcc --version
```

### 3. cuDNN安装 (可选)

从NVIDIA官网下载cuDNN并安装

---

## IDE配置

### VS Code (推荐)

**安装扩展**:
1. Python (Microsoft)
2. Jupyter (Microsoft)
3. Pylance (Microsoft)
4. GitLens
5. Docker (如需)

**settings.json**:
```json
{
    "python.defaultInterpreterPath": "/path/to/anaconda3/envs/battery-ai/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "jupyter.jupyterServerType": "local"
}
```

### PyCharm (可选)

配置Anaconda解释器:
- Settings → Project → Python Interpreter
- 选择 `/path/to/anaconda3/envs/battery-ai/bin/python`

---

## Docker环境 (可选)

### Dockerfile

```dockerfile
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04

# 基础环境
RUN apt-get update && apt-get install -y \
    python3.10 python3-pip git wget curl \
    && rm -rf /var/lib/apt/lists/*

# 工作目录
WORKDIR /workspace

# 复制依赖文件
COPY requirements-full.txt .

# 安装Python包
RUN pip3 install --no-cache-dir -r requirements-full.txt

# 暴露端口
EXPOSE 8888 8501 8000

CMD ["/bin/bash"]
```

### 构建与运行

```bash
# 构建镜像
docker build -t battery-ai:latest .

# 运行容器 (GPU支持)
docker run --gpus all -it -p 8888:8888 -p 8501:8501 \
    -v $(pwd):/workspace battery-ai:latest

# Jupyter
jupyter notebook --ip=0.0.0.0 --port=8888 --allow-root
```

---

## 环境变量配置

### .env文件

创建 `.env` (不要提交到Git):

```bash
# OpenAI API
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1

# Anthropic Claude
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxx

# 向量数据库 (如Pinecone)
PINECONE_API_KEY=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
PINECONE_ENV=us-west1-gcp

# MLflow
MLFLOW_TRACKING_URI=http://localhost:5000

# Weights & Biases
WANDB_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 加载环境变量

```python
from dotenv import load_dotenv
import os

load_dotenv()

openai_key = os.getenv('OPENAI_API_KEY')
```

安装:
```bash
pip install python-dotenv
```

---

## 验证安装

### 测试脚本

创建 `tools/开发环境/test_environment.py`:

```python
#!/usr/bin/env python
"""环境测试脚本"""

def test_pytorch():
    import torch
    print(f"✓ PyTorch: {torch.__version__}")
    print(f"  CUDA Available: {torch.cuda.is_available()}")
    if torch.cuda.is_available():
        print(f"  CUDA Version: {torch.version.cuda}")
        print(f"  GPU Count: {torch.cuda.device_count()}")
        print(f"  GPU Name: {torch.cuda.get_device_name(0)}")

def test_sklearn():
    import sklearn
    print(f"✓ Scikit-learn: {sklearn.__version__}")

def test_xgboost():
    import xgboost as xgb
    print(f"✓ XGBoost: {xgb.__version__}")

def test_langchain():
    import langchain
    print(f"✓ LangChain: {langchain.__version__}")

def test_chromadb():
    import chromadb
    print(f"✓ ChromaDB: {chromadb.__version__}")

def test_streamlit():
    import streamlit
    print(f"✓ Streamlit: {streamlit.__version__}")

def test_pandas():
    import pandas as pd
    import numpy as np
    print(f"✓ Pandas: {pd.__version__}")
    print(f"✓ NumPy: {np.__version__}")

if __name__ == "__main__":
    print("=== 环境测试 ===\n")

    try:
        test_pytorch()
        test_sklearn()
        test_xgboost()
        test_langchain()
        test_chromadb()
        test_streamlit()
        test_pandas()
        print("\n✅ 所有库安装成功!")
    except Exception as e:
        print(f"\n❌ 错误: {e}")
```

运行:
```bash
python tools/开发环境/test_environment.py
```

---

## 常见问题

### 1. CUDA版本不匹配

**问题**: `RuntimeError: CUDA error: no kernel image is available`

**解决**:
```bash
# 卸载PyTorch
pip uninstall torch torchvision torchaudio

# 检查CUDA版本
nvidia-smi  # 查看CUDA Version

# 安装匹配版本
# 如CUDA 11.8
conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia
```

### 2. ChromaDB sqlite3错误

**问题**: `ValueError: sqlite3 version must be >= 3.35.0`

**解决**:
```bash
# 安装新版sqlite
conda install -c conda-forge sqlite
# 或
pip install pysqlite3-binary
```

### 3. 内存不足

**解决**:
- 减小batch_size
- 使用梯度累积
- 模型量化

---

## 更新日志

- 2025-01-24: 初始版本
- 待更新...

---

**维护者**: 研究团队
